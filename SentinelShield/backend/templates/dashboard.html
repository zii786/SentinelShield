{% extends "base.html" %}
{% block content %}
<div class="dashboard-container">
    <h2 style="text-align:center; margin-top:2rem;">Real-Time Dashboard</h2>
    <div class="card-grid">
        <div class="card" id="total_requests">Loading total requests...</div>
        <div class="card" id="unique_visitors">Loading unique visitors...</div>
        <div class="card" id="requests_per_minute">Loading requests per minute...</div>
        <div class="card" id="last_updated">Loading last updated time...</div>
    </div>
    <div style="margin-top:2rem;">
        <h3>Recent Suspicious Events</h3>
        <div style="margin-bottom:1rem; display:flex; gap:1rem; align-items:center; flex-wrap:wrap;">
            <input type="text" id="search-ip" placeholder="Search by IP..." style="padding:6px 12px; border-radius:6px; border:1px solid #ccc; min-width:180px;">
            <select id="filter-type" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc;">
                <option value="">All Types</option>
                <option value="Traffic Spike">Traffic Spike</option>
                <option value="Rate Limit Exceeded">Rate Limit Exceeded</option>
                <option value="Suspicious Header">Suspicious Header</option>
            </select>
            <label>Start:
                <input type="datetime-local" id="start-datetime" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc;">
            </label>
            <label>End:
                <input type="datetime-local" id="end-datetime" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc;">
            </label>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Type</th>
                        <th>IP Address</th>
                        <th>Timestamp</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="events-tbody">
                    {% for event in recent_events %}
                    <tr class="{% if event.type == 'Suspicious User-Agent' %}warning-event{% endif %}">
                        <td>{{ loop.index }}</td>
                        <td>{{ event.type }}</td>
                        <td>{{ event.ip | default('-') }}</td>
                        <td>{{ event.timestamp }}</td>
                        <td>{{ event.details }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5">No suspicious events recorded yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
    function fetchData() {
        fetch('/data')
            .then(res => res.json())
            .then(data => {
                document.getElementById('total_requests').innerText = "Total Requests: " + data.total_requests;
                document.getElementById('unique_visitors').innerText = "Unique Visitors: " + data.unique_visitors;
                document.getElementById('requests_per_minute').innerText = "Requests/Min: " + data.requests_per_minute;
                document.getElementById('last_updated').innerText = "Last Updated: " + data.last_updated;
            });
    }
    setInterval(fetchData, 5000);
    fetchData();

    let allEvents = [];
    function renderEvents(events) {
        const tbody = document.getElementById('events-tbody');
        tbody.innerHTML = '';
        if (events.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5">No suspicious events detected.</td></tr>';
        } else {
            events.forEach((event, index) => {
                let rowClass = '';
                if (event.type === 'Suspicious User-Agent') rowClass = 'warning-event';
                
                tbody.innerHTML += `
                    <tr class='${rowClass}'>
                        <td>${index + 1}</td>
                        <td>${event.type}</td>
                        <td>${event.ip ? event.ip : '-'}</td>
                        <td>${event.timestamp}</td>
                        <td>${event.details}</td>
                    </tr>`;
            });
        }
    }

    function filterAndRenderEvents() {
        const searchIp = document.getElementById('search-ip').value.trim().toLowerCase();
        const filterType = document.getElementById('filter-type').value;
        const startDt = document.getElementById('start-datetime').value;
        const endDt = document.getElementById('end-datetime').value;
        let filtered = allEvents.filter(event => {
            const matchesIp = !searchIp || (event.ip && event.ip.toLowerCase().includes(searchIp));
            const matchesType = !filterType || event.type === filterType;
            let matchesDate = true;
            if (startDt) {
                const eventTime = new Date(event.timestamp.replace(' ', 'T'));
                matchesDate = matchesDate && (eventTime >= new Date(startDt));
            }
            if (endDt) {
                const eventTime = new Date(event.timestamp.replace(' ', 'T'));
                matchesDate = matchesDate && (eventTime <= new Date(endDt));
            }
            return matchesIp && matchesType && matchesDate;
        });
        renderEvents(filtered);
    }

    function fetchEvents() {
        fetch('/recent-events')
            .then(res => res.json())
            .then(events => {
                allEvents = events;
                filterAndRenderEvents();
            });
    }
    setInterval(fetchEvents, 5000);
    fetchEvents();

    document.getElementById('search-ip').addEventListener('input', filterAndRenderEvents);
    document.getElementById('filter-type').addEventListener('change', filterAndRenderEvents);
    document.getElementById('start-datetime').addEventListener('change', filterAndRenderEvents);
    document.getElementById('end-datetime').addEventListener('change', filterAndRenderEvents);
</script>
{% endblock %}
